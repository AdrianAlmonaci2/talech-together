{"version":3,"file":"EventAnnotation.js","sourceRoot":"../src/","sources":["components/LineChart/eventAnnotation/EventAnnotation.tsx"],"names":[],"mappings":"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","sourcesContent":["import * as React from 'react';\nimport { ScaleTime } from 'd3-scale';\nimport { findIndex } from '@fluentui/react/lib/Utilities';\nimport { ILineDef, LabelLink, ILabelDef } from './LabelLink';\nimport { IEventsAnnotationProps } from '../LineChart.types';\n\ninterface IEventsAnnotationExtendProps extends IEventsAnnotationProps {\n  scale: ScaleTime<number, number>;\n  chartYBottom: number;\n  chartYTop: number;\n}\n\nexport const EventsAnnotation: React.FunctionComponent<IEventsAnnotationExtendProps> = props => {\n  const textWidth = props.labelWidth ? props.labelWidth : 105;\n  const textY = props.chartYTop - 20;\n  const lineTopY = textY + 7;\n  const textPadding = 5;\n  const lineHeight = 18;\n  const fontSize = '10pt';\n  const axisRange = props.scale.range();\n\n  const lineDefs: ILineDef[] = props.events.map(e => ({ ...e, x: props.scale(e.date) }));\n\n  lineDefs.sort((e1, e2) => +e1.date - +e2.date);\n  const darkThemeMq = window.matchMedia('(prefers-color-scheme: dark)');\n  const fill: string | undefined = darkThemeMq.matches ? 'rgb(255,255,255)' : props.strokeColor;\n\n  const lines = uniqBy(lineDefs, x => x.date.toString()).map((x, i) => (\n    <line key={i} x1={x.x} x2={x.x} y1={lineTopY} y2={props.chartYBottom} stroke={fill} strokeDasharray=\"8\" />\n  ));\n\n  const labelLinks = calculateLabels(lineDefs, textWidth + textPadding, axisRange[1], axisRange[0]).map((x, i) => (\n    <LabelLink\n      key={i}\n      {...{\n        lineDefs,\n        labelDef: x,\n        textY,\n        textWidth,\n        textLineHeight: lineHeight,\n        textFontSize: fontSize,\n        textColor: props.labelColor,\n        mergedLabel: props.mergedLabel,\n      }}\n    />\n  ));\n\n  return (\n    <>\n      {lines}\n      {labelLinks}\n    </>\n  );\n};\n\nfunction calculateLabels(lineDefs: ILineDef[], textWidth: number, maxX: number, minX: number): ILabelDef[] {\n  const calculateLabel = (lastX: number, currentIdx: number): ILabelDef[] => {\n    // base case 1\n    if (currentIdx === lineDefs.length) {\n      return [];\n    }\n\n    const { x } = lineDefs[currentIdx];\n    const leftXBoundary = x - textWidth;\n\n    // cannot render on top of other text\n    if (x < lastX) {\n      return [];\n    }\n\n    // base case 2\n    if (currentIdx === lineDefs.length - 1) {\n      if (lastX < leftXBoundary) {\n        return [{ x: x, anchor: 'end', aggregatedIdx: [currentIdx] }];\n      } else if (x + textWidth < maxX) {\n        return [{ x: x, anchor: 'start', aggregatedIdx: [currentIdx] }];\n      }\n\n      return [];\n    }\n\n    if (lastX < leftXBoundary) {\n      // label on left side\n      return backtrack(currentIdx, 'end');\n    } else {\n      // label on right side\n      return backtrack(currentIdx, 'start');\n    }\n  };\n\n  const backtrack = (currentIdx: number, anchor: 'start' | 'end'): ILabelDef[] => {\n    const bd = anchor === 'end' ? lineDefs[currentIdx].x : lineDefs[currentIdx].x + textWidth;\n\n    let idx = findIndex(\n      lineDefs,\n      ds => ds.x > bd && (ds.x - textWidth >= bd || ds.x + textWidth < maxX),\n      currentIdx + 1,\n    );\n    if (idx === -1) {\n      idx = lineDefs.length;\n    }\n\n    const aggregatedIdx: number[] = [];\n    for (let i = currentIdx; i < idx; i++) {\n      aggregatedIdx.push(i);\n    }\n    const next = calculateLabel(bd, idx);\n\n    next.unshift({ x: lineDefs[currentIdx].x, anchor, aggregatedIdx });\n    return next;\n  };\n\n  return calculateLabel(minX, 0);\n}\n\n/** Get unique items of `arr`, comparing based on the result of calling `iteratee` on each item. */\nfunction uniqBy<T>(arr: T[], iteratee: (x: T) => string): T[] {\n  const seen: string[] = [];\n  const result: T[] = [];\n  for (const x of arr) {\n    const comp = iteratee(x);\n    if (seen.indexOf(comp) === -1) {\n      result.push(x);\n      seen.push(comp);\n    }\n  }\n  return result;\n}\n"]}